<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>QR code Generator</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js"
        integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"
        referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.qrcode/1.0/jquery.qrcode.min.js"
        integrity="sha512-NFUcDlm4V+a2sjPX7gREIXgCSFja9cHtKPOL1zj6QhnE0vcY695MODehqkaGYTLyL2wxe/wtr4Z49SvqXq12UQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/encoding-japanese/1.0.30/encoding.min.js"
        integrity="sha512-rqL5c2sp6KdRdB27P16dSYF9J3/WrP+UHrKuzWiN6304wz0bzv1ZE8G+zieQGSnNfg9UasgKNOQzv4yir7+Prg=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>

<body>
    <div class="container-fluid">
        <div class="row" style="padding: 1em">
            <div class="col-sm-6">
                <form>
                    <ul class="nav nav-tabs">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" value="free_text">Free text</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" value="url">URL</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" value="wifi">Wifi setup</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" value="vcard">vCard</a>
                        </li>
                    </ul>
                    <div>
                        <label>Contents</label>
                        <div id="free_text" class="tab input-group mb-3">
                            <textarea type="text" id="value" style="width: 90%; height: 80vh"></textarea>
                        </div>
                        <div id="url" class="tab input-group mb-3 d-none">
                            <span class="input-group-text" id="basic-addon1">URL:</span>
                            <input type="text" class="form-control" id="basic-url" aria-describedby="basic-addon1" />
                        </div>
                        <div id="wifi" class="tab d-none">
                            <div class="input-group mb-3">
                                <span class="input-group-text" id="basic-addon13">ESSID</span>
                                <input type="text" class="form-control" id="essid"
                                    aria-describedby="basic-addon13" />
                            </div>
                            <div class="input-group mb-3">
                                <span class="input-group-text" id="basic-addo14">Password</span>
                                <input type="password" class="form-control" id="password"
                                    aria-describedby="basic-addon14" />
                            </div>
                        </div>
                        <div id="vcard" class="tab d-none">
                            <div class="input-group mb-3">
                                <span class="input-group-text" id="basic-addon2">First name</span>
                                <input type="text" class="form-control" id="first_name"
                                    aria-describedby="basic-addon2" />
                            </div>
                            <div class="input-group mb-3">
                                <span class="input-group-text" id="basic-addon3">Family name</span>
                                <input type="text" class="form-control" id="family_name"
                                    aria-describedby="basic-addon3" />
                            </div>
                            <div class="input-group mb-3">
                                <span class="input-group-text" id="basic-addon4">First name(kana)</span>
                                <input type="text" class="form-control" id="first_name_kana"
                                    aria-describedby="basic-addon4" />
                            </div>
                            <div class="input-group mb-3">
                                <span class="input-group-text" id="basic-addon5">Family name(kana)</span>
                                <input type="text" class="form-control" id="family_name_kana"
                                    aria-describedby="basic-addon5" />
                            </div>
                            <div class="input-group mb-3">
                                <span class="input-group-text" id="basic-addon6">Organization</span>
                                <input type="text" class="form-control" id="organization"
                                    aria-describedby="basic-addon6" />
                            </div>
                            <div class="input-group mb-3">
                                <span class="input-group-text" id="basic-addon7">Title</span>
                                <input type="text" class="form-control" id="title" aria-describedby="basic-addon7" />
                            </div>
                            <div class="input-group mb-3">
                                <span class="input-group-text" id="basic-addon8">Telephone number</span>
                                <input type="text" class="form-control" id="tel_voice"
                                    aria-describedby="basic-addon8" />
                            </div>
                            <div class="input-group mb-3">
                                <span class="input-group-text" id="basic-addon9">Fax number</span>
                                <input type="text" class="form-control" id="tel_fax"
                                    aria-describedby="basic-addon9" />
                            </div>
                            <div class="input-group mb-3">
                                <span class="input-group-text" id="basic-addon10">e-Mail address</span>
                                <input type="text" class="form-control" id="email" aria-describedby="basic-addon10" />
                            </div>
                            <div class="input-group mb-3">
                                <span class="input-group-text" id="basic-addon11">URL(Work)</span>
                                <input type="text" class="form-control" id="url_work"
                                    aria-describedby="basic-addon11" />
                            </div>
                            <div class="input-group mb-3">
                                <span class="input-group-text" id="basic-addon12">URL(Private)</span>
                                <input type="text" class="form-control" id="url_private"
                                    aria-describedby="basic-addon12" />
                            </div>
                        </div>
                    </div>
                    <div class="d-flex">
                        <div class="btn-group p-2">
                            <button id="btnGen" class="btn btn-primary" name="size" type="button">
                                Generate!
                            </button>
                        </div>
                        <div class="p-2"></div>
                        <div class="btn-group p-2">
                            <button id="btnVcard" class="btn btn-primary" name="downlaod-vcoard" type="button" disabled>
                                Download vCard
                            </button>
                        </div>
                        <div class="p-2"></div>
                        <div class="p-2">
                            <input class="form-check-input" type="checkbox" value="" id="chkIsSjis" checked/>
                            <label class="form-check-label" for="chkIsSjis">
                                Shift-JIS mode
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div id="QRCode" class="col-sm-6 border" style="color: crimson; padding: 1em"></div>
        </div>
    </div>
    <script type="text/javascript">
        /**
         * getElementByIdする糖衣構文
         * @param {string} text
         */
        function _$(id) {
            return document.getElementById(id);
        }

        /**
         * querySelectorする糖衣構文
         */
        function $$(query) {
            return document.querySelectorAll(query);
        }

        /**
         * 文字エンコードの変換
         * @param {string} str エンコード変換して耐文字列
         * @return {string} 変換後の文字列
         */
        function encode(str) {
            return _$("chkIsSjis").checked
                ? Encoding.convert(str, "SJIS")
                : Encoding.convert(str, "UTF-8");
        }

        // 画面の描画が終わったら初期設定を実行する
        window.onload = () => {
            _$("btnGen").addEventListener("click", e => {
                const size = 200; // QRコード画像のサイズ（縦横兼用）
                let source = "";

                // 表示しているタブによって取得する値を変える
                switch ($$(".nav-link.active")[0].getAttribute("value")) {
                    case "free_text":
                        source = encode(_$("value").value);
                        break

                    case "url":
                        source = encode(_$("basic-url").value);
                        break

                    case "wifi":
                        const essid = _$("essid").value
                        const password = _$("password").value
                        source = `WIFI:T:WPA;S:${essid};P:${password};;`;
                        break

                    case "vcard":
                        source = encode(generateVcard());
                        break
                }
                console.log(source)

                // QRコードの生成
                try {
                    const strlen = source.length;
                    $("#QRCode").html("").qrcode({
                        width: strlen > size ? strlen : size,
                        height: strlen > size ? strlen : size,
                        text: source,
                    });
                } catch (e) {
                    $("#QRCode").html("").append("The number of characters is over. Please keep it within 600 characters.");
                }
            });

            // vCardのダウンロード
            _$("btnVcard").addEventListener("click", e => {
                downloadVcardFile();
            });

            // タブの切替
            $$(".nav-link").forEach(nav_elem => {
                nav_elem.addEventListener("click", event => {
                    $$(".nav-link").forEach(elem => {
                        elem.classList.remove("active")
                    })
                    $$(".tab").forEach(elem => {
                        elem.classList.add("d-none")
                    })
                    event.target.classList.add("active")
                    _$(event.target.getAttribute("value")).classList.remove("d-none")

                    if (event.target.getAttribute("value") === "vcard") {
                        _$("btnVcard").disabled = false
                    } else {
                        _$("btnVcard").disabled = true
                    }
                })
            })
        }

        /**
         * vCard用の文字列の生成
         * @returns {string}
         */
        function generateVcard() {
            const charset = _$("chkIsSjis").checked
                ? "CHARSET=SHIFT_JIS:"
                : "CHARSET=UTF-8:";

            const first_name = _$("first_name").value
            const family_name = _$("family_name").value
            const first_name_kana = _$("first_name_kana").value
            const family_name_kana = _$("family_name_kana").value
            const organization = _$("organization").value
            const title = _$("title").value
            const tel_voice = _$("tel_voice").value
            const tel_fax = _$("tel_fax").value
            const email = _$("email").value
            const url_work = _$("url_work").value
            const url_private = _$("url_private").value

            let source = "BEGIN:VCARD\nVERSION:2.1\n"
            if (family_name || first_name) {
                source += `FN;${charset}${family_name} ${first_name}\n`
                    + `N;${charset}${family_name};${first_name}\n`
            }
            if (family_name_kana || first_name_kana) {
                source += `SORT-STRING;${charset}${family_name_kana} ${first_name_kana}\n`
                if (family_name_kana) {
                    source += `X-PHONETIC-LAST-NAME;${charset}${family_name_kana}\n`
                }
                if (first_name_kana) {
                    source += `X-PHONETIC-FIRST-NAME;${charset}${first_name_kana}\n`
                }
            }
            if (organization) {
                source += `ORG;${charset}${organization}\n`
            }
            if (title) {
                source += `TITLE;${charset}${title}\n`
            }
            if (tel_voice) {
                source += `TEL;;VOICE:${tel_voice}\n`
            }
            if (tel_fax) {
                source += `TEL;;FAX:${tel_fax}\n`
            }
            if (email) {
                source += `EMAIL;;INTERNET:${email}\n`
            }
            if (url_work) {
                source += `URL;WORK:${url_work}\n`
            }
            if (url_private) {
                source += `URL;HOME:${url_private}\n`
            }
            source += "END:VCARD";

            return source;
        }

        /**
         * vCardファイルのダウンロード
         */
        function downloadVcardFile() {
            const charset = _$("chkIsSjis").checked
                ? "CHARSET=SHIFT_JIS:"
                : "CHARSET=UTF-8:";

            // アンカータグの作成
            const downLoadLink = document.createElement("a");

            // ダウンロードするHTML文章の生成
            const outputDataString = encode(stringToArray(generateVcard()));  // バイト列のまま渡す
            const downloadFileName = (_$('title').value != "" ? _$('title').value : _$('first_name').value + _$('family_name').value) + ".vcf"
            downLoadLink.download = downloadFileName;
            downLoadLink.href = URL.createObjectURL(new Blob([new Uint8Array(outputDataString)], { type: `text/x-vcard` }));
            downLoadLink.dataset.downloadurl = [`text/x-vcard`, downloadFileName, downLoadLink.href].join(":");
            downLoadLink.click();
        }

        /**
         * 文字列を配列に変換
         * @param {string} str 配列に変換したい文字列
         * @returns {Uint8Array} 配列
         */
        function stringToArray(str) {
            let array = [];
            for(let i = 0; i < str.length; i++) {
                array.push(str.charCodeAt(i));
            }
            return array;
        };
    </script>
</body>

</html>
